import React, { useState, useEffect } from 'react';
import { Play, Volume2, CheckCircle, XCircle, RefreshCw, Home, ChevronRight, Trophy, Smartphone, Puzzle, Hash, Delete } from 'lucide-react';

// --- DATA & CONTENT ---

const MINIMAL_PAIRS_DATA = [
  {
    id: 1,
    audioText: "I want three of them.",
    correctOption: "I want three of them.",
    options: ["I want free of them.", "I want three of them."],
    explanation: "The 'th' sound uses your teeth. 'Free' uses your lip."
  },
  {
    id: 2,
    audioText: "Look at that ship.",
    correctOption: "Look at that ship.",
    options: ["Look at that ship.", "Look at that sheep."],
    explanation: "Ship (short 'i') is quick. Sheep (long 'ee') is long."
  }
];

const SCRAMBLE_DATA = [
  {
    id: 1,
    audioText: "The cat sat on the mat.",
    words: ["The", "cat", "sat", "on", "the", "mat."]
  },
  {
    id: 2,
    audioText: "Where is the nearest station?",
    words: ["Where", "is", "the", "nearest", "station?"]
  }
];

const MISSING_LINK_DATA = [
  {
    id: 1,
    audioText: "Can I have a glass of water?",
    parts: ["Can I have a", "of water?"], // Split text around the blank
    correctWord: "glass",
    options: ["grass", "glass", "class", "gas"]
  },
  {
    id: 2,
    audioText: "She walked to the library.",
    parts: ["She", "to the library."],
    correctWord: "walked",
    options: ["work", "walked", "woke", "walking"]
  },
  {
    id: 3,
    audioText: "The sun is very hot today.",
    parts: ["The", "is very hot today."],
    correctWord: "sun",
    options: ["son", "soon", "sun", "some"]
  }
];

const NUMBER_DATA = [
  {
    id: 1,
    audioText: "The number is five, two, one.",
    answer: "521",
    hint: "Type the digits you hear."
  },
  {
    id: 2,
    audioText: "It costs twelve dollars and fifty cents.",
    answer: "12.50",
    hint: "Type the price (e.g. 10.50)"
  },
  {
    id: 3,
    audioText: "Call me at five, five, five, zero, one, nine, nine.",
    answer: "5550199",
    hint: "Type the phone number."
  }
];

// --- HELPER FUNCTIONS ---

const speak = (text) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; 
    utterance.rate = 0.85; // Slower for kids
    utterance.volume = 1;
    // Try to select a "Google US English" voice if available for better quality
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => v.name.includes("Google US English")) || voices[0];
    if (preferredVoice) utterance.voice = preferredVoice;
    
    window.speechSynthesis.speak(utterance);
  }
};

// --- COMPONENTS ---

export default function App() {
  const [currentScreen, setCurrentScreen] = useState('home'); 
  const [score, setScore] = useState(0);

  const goHome = () => {
    setCurrentScreen('home');
    setScore(0);
  };

  return (
    <div className="min-h-screen bg-sky-100 font-sans text-slate-800 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-slate-200">
      
      {/* Header */}
      <header className="bg-sky-500 text-white p-4 shadow-lg flex justify-between items-center z-10 rounded-b-3xl">
        <button onClick={goHome} className="flex items-center gap-2 hover:scale-105 transition-transform active:scale-95">
          <div className="bg-white/20 p-2 rounded-full">
            <Home className="w-5 h-5" />
          </div>
          <h1 className="text-xl font-extrabold tracking-tight">Listen Up!</h1>
        </button>
        {currentScreen !== 'home' && (
          <div className="flex items-center gap-1 bg-yellow-400 text-yellow-900 px-4 py-1.5 rounded-full shadow-sm border-2 border-yellow-500">
            <Trophy className="w-4 h-4" />
            <span className="font-bold">{score}</span>
          </div>
        )}
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-y-auto bg-sky-100">
        {currentScreen === 'home' && <HomeScreen onSelectMode={setCurrentScreen} />}
        {currentScreen === 'pairs' && <MinimalPairsGame onScore={() => setScore(s => s + 10)} goHome={goHome} />}
        {currentScreen === 'scramble' && <ScrambleGame onScore={() => setScore(s => s + 20)} goHome={goHome} />}
        {currentScreen === 'missingLink' && <MissingLinkGame onScore={() => setScore(s => s + 15)} goHome={goHome} />}
        {currentScreen === 'numbers' && <NumberCruncherGame onScore={() => setScore(s => s + 15)} goHome={goHome} />}
      </main>

    </div>
  );
}

// --- SUB-COMPONENTS ---

function HomeScreen({ onSelectMode }) {
  const handleStart = (mode) => {
    if ('speechSynthesis' in window) {
      const warmUp = new SpeechSynthesisUtterance('');
      warmUp.volume = 0; 
      window.speechSynthesis.speak(warmUp);
    }
    onSelectMode(mode);
  };

  const ActivityCard = ({ mode, title, desc, color, icon: Icon }) => (
    <button 
      onClick={() => handleStart(mode)}
      className={`group relative w-full bg-white p-5 rounded-3xl shadow-[0_4px_0_0_rgba(0,0,0,0.1)] border-2 border-transparent hover:border-${color}-400 active:translate-y-1 active:shadow-none transition-all text-left flex items-center justify-between overflow-hidden`}
    >
      <div className={`absolute top-0 left-0 w-2 h-full bg-${color}-400`}></div>
      <div className="flex items-center gap-4 pl-4">
        <div className={`p-3 rounded-2xl bg-${color}-100 text-${color}-600`}>
          <Icon className="w-6 h-6" />
        </div>
        <div>
          <h3 className="text-lg font-black text-slate-700 leading-tight">{title}</h3>
          <p className="text-xs font-medium text-slate-400 mt-1">{desc}</p>
        </div>
      </div>
      <ChevronRight className="w-6 h-6 text-slate-300 group-hover:text-slate-500" />
    </button>
  );

  return (
    <div className="p-6 flex flex-col gap-4 animate-in fade-in zoom-in duration-300 pb-10">
      <div className="text-center py-4">
        <h2 className="text-2xl font-black text-sky-600 mb-1">Let's Play!</h2>
        <p className="text-sky-800/60 font-medium">Choose a game to start.</p>
      </div>

      <ActivityCard 
        mode="pairs" 
        title="Sound Check" 
        desc="Which word did you hear?" 
        color="orange"
        icon={Volume2}
      />

      <ActivityCard 
        mode="scramble" 
        title="Word Order" 
        desc="Build the sentence correctly." 
        color="purple"
        icon={Puzzle}
      />

      <ActivityCard 
        mode="missingLink" 
        title="Missing Link" 
        desc="Fill in the blank space." 
        color="green"
        icon={CheckCircle}
      />

      <ActivityCard 
        mode="numbers" 
        title="Number Cruncher" 
        desc="Type the numbers you hear." 
        color="rose"
        icon={Hash}
      />

      {/* Mobile Hint */}
      <div className="mt-6 bg-white/50 border border-white p-4 rounded-xl flex gap-3 text-sm text-sky-700">
        <Smartphone className="w-5 h-5 shrink-0" />
        <div>
          <p className="font-bold text-xs uppercase tracking-wider">Note for iPhone</p>
          <p className="text-xs opacity-80 leading-snug">Turn off Silent Mode (switch on the side) to hear the audio.</p>
        </div>
      </div>
    </div>
  );
}

// --- GAME COMPONENTS ---

// 1. Minimal Pairs
function MinimalPairsGame({ onScore, goHome }) {
  const [qIndex, setQIndex] = useState(0);
  const [status, setStatus] = useState('listening'); 
  const [selectedOption, setSelectedOption] = useState(null);

  const question = MINIMAL_PAIRS_DATA[qIndex];
  const isFinished = !question;

  useEffect(() => {
    if (question) setTimeout(() => speak(question.audioText), 600);
  }, [qIndex, question]);

  const handleChoice = (option) => {
    if (status !== 'listening') return;
    setSelectedOption(option);
    if (option === question.correctOption) {
      setStatus('correct');
      speak("Great job!");
      onScore();
    } else {
      setStatus('wrong');
      speak("Oops, try again.");
    }
  };

  const nextQuestion = () => {
    setStatus('listening');
    setSelectedOption(null);
    setQIndex(prev => prev + 1);
  };

  if (isFinished) return <GameOver score="You have a good ear!" onRetry={goHome} color="orange" />;

  return (
    <div className="flex flex-col h-full p-6 animate-in slide-in-from-right duration-300">
      <ProgressBar current={qIndex} total={MINIMAL_PAIRS_DATA.length} color="bg-orange-400" />
      
      <div className="flex-1 flex flex-col items-center justify-center">
        <AudioButton onClick={() => speak(question.audioText)} color="orange" />
        
        <div className="flex flex-col gap-3 w-full max-w-sm">
          {question.options.map((option, idx) => {
            let style = "bg-white border-b-4 border-slate-200 text-slate-600";
            if (status === 'correct' && option === question.correctOption) style = "bg-green-100 border-green-400 text-green-700";
            if (status === 'wrong' && option === selectedOption) style = "bg-red-100 border-red-400 text-red-700";
            
            return (
              <button 
                key={idx} 
                onClick={() => handleChoice(option)}
                disabled={status !== 'listening'}
                className={`p-4 rounded-2xl font-bold text-lg text-left transition-all active:scale-95 active:border-b-0 active:translate-y-1 ${style}`}
              >
                {option}
              </button>
            );
          })}
        </div>
      </div>

      <FeedbackArea status={status} nextFn={nextQuestion} explanation={question.explanation} />
    </div>
  );
}

// 2. Sentence Scramble
function ScrambleGame({ onScore, goHome }) {
  const [qIndex, setQIndex] = useState(0);
  const [shuffledWords, setShuffledWords] = useState([]);
  const [userOrder, setUserOrder] = useState([]);
  const [status, setStatus] = useState('playing');

  const question = SCRAMBLE_DATA[qIndex];
  const isFinished = !question;

  useEffect(() => {
    if (question) {
      const shuffled = [...question.words].sort(() => Math.random() - 0.5);
      setShuffledWords(shuffled.map((w, i) => ({ id: i, text: w })));
      setUserOrder([]);
      setStatus('playing');
      setTimeout(() => speak(question.audioText), 600);
    }
  }, [qIndex, question]);

  const handleWordTap = (wordObj) => {
    if (status === 'success') return;
    setShuffledWords(prev => prev.filter(w => w.id !== wordObj.id));
    setUserOrder(prev => [...prev, wordObj]);
  };

  const handleReturnWord = (wordObj) => {
    if (status === 'success') return;
    setUserOrder(prev => prev.filter(w => w.id !== wordObj.id));
    setShuffledWords(prev => [...prev, wordObj]);
  };

  const checkAnswer = () => {
    const currentSentence = userOrder.map(w => w.text).join(' ');
    if (currentSentence === question.words.join(' ')) {
      setStatus('success');
      speak("Perfect!");
      onScore();
    } else {
      speak("Not quite.");
      speak(question.audioText);
    }
  };

  if (isFinished) return <GameOver score="Sentence Master!" onRetry={goHome} color="purple" />;

  return (
    <div className="flex flex-col h-full p-4 animate-in slide-in-from-right duration-300">
      <ProgressBar current={qIndex} total={SCRAMBLE_DATA.length} color="bg-purple-400" />
      
      <div className="flex justify-center my-4">
        <button onClick={() => speak(question.audioText)} className="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-full font-bold shadow-sm active:scale-95 transition-transform text-sm">
          <Volume2 className="w-4 h-4" /> Replay Audio
        </button>
      </div>

      {/* Answer Tray */}
      <div className="bg-white rounded-3xl p-4 min-h-[140px] shadow-[inset_0_2px_4px_rgba(0,0,0,0.05)] border-2 border-purple-100 mb-6 flex flex-wrap gap-2 content-start">
        {userOrder.length === 0 && <span className="text-slate-300 italic w-full text-center mt-8">Tap words below...</span>}
        {userOrder.map((w) => (
          <button key={w.id} onClick={() => handleReturnWord(w)} className="bg-purple-500 text-white px-3 py-2 rounded-xl shadow-sm border-b-4 border-purple-700 text-lg font-bold active:scale-95 active:border-b-0 active:translate-y-1">
            {w.text}
          </button>
        ))}
      </div>

      {/* Word Bank */}
      <div className="flex flex-wrap justify-center gap-2 mb-4">
        {shuffledWords.map((w) => (
          <button key={w.id} onClick={() => handleWordTap(w)} className="bg-white border-2 border-slate-200 border-b-4 text-slate-700 px-3 py-2 rounded-xl text-lg font-bold active:scale-95 active:border-b-2 active:translate-y-0.5">
            {w.text}
          </button>
        ))}
      </div>

      <div className="mt-auto">
        {status === 'success' ? (
          <button onClick={() => setQIndex(p => p + 1)} className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-black shadow-[0_4px_0_0_#15803d] active:shadow-none active:translate-y-1 transition-all">
            Next Sentence
          </button>
        ) : (
          <button onClick={checkAnswer} disabled={shuffledWords.length > 0} className="w-full bg-slate-800 disabled:bg-slate-300 text-white py-4 rounded-2xl font-black shadow-[0_4px_0_0_#0f172a] active:shadow-none active:translate-y-1 transition-all">
            Check Answer
          </button>
        )}
      </div>
    </div>
  );
}

// 3. Missing Link (Cloze)
function MissingLinkGame({ onScore, goHome }) {
  const [qIndex, setQIndex] = useState(0);
  const [status, setStatus] = useState('listening'); 
  const [selected, setSelected] = useState(null);

  const question = MISSING_LINK_DATA[qIndex];
  const isFinished = !question;

  useEffect(() => {
    if (question) setTimeout(() => speak(question.audioText), 600);
  }, [qIndex, question]);

  const handleGuess = (word) => {
    if (status !== 'listening') return;
    setSelected(word);
    if (word === question.correctWord) {
      setStatus('correct');
      speak("That's right!");
      onScore();
    } else {
      setStatus('wrong');
      speak("Try again.");
    }
  };

  const nextQuestion = () => {
    setStatus('listening');
    setSelected(null);
    setQIndex(prev => prev + 1);
  };

  if (isFinished) return <GameOver score="Vocabulary Star!" onRetry={goHome} color="green" />;

  return (
    <div className="flex flex-col h-full p-6 animate-in slide-in-from-right duration-300">
      <ProgressBar current={qIndex} total={MISSING_LINK_DATA.length} color="bg-green-400" />
      
      <div className="flex-1 flex flex-col items-center pt-8">
        <AudioButton onClick={() => speak(question.audioText)} color="green" />

        {/* Sentence Display */}
        <div className="bg-white p-6 rounded-3xl shadow-sm border-2 border-green-100 w-full text-center mb-8 mt-6">
          <p className="text-xl text-slate-700 font-medium leading-relaxed">
            {question.parts[0]} 
            <span className={`inline-block mx-2 px-3 py-1 rounded-lg border-b-2 font-bold ${status === 'correct' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-slate-100 text-slate-400 border-slate-300'}`}>
              {status === 'correct' ? question.correctWord : "____"}
            </span> 
            {question.parts[1]}
          </p>
        </div>

        {/* Options Grid */}
        <div className="grid grid-cols-2 gap-3 w-full">
          {question.options.map((word, idx) => {
             let style = "bg-white border-b-4 border-slate-200 text-slate-600";
             if (status === 'correct' && word === question.correctWord) style = "bg-green-500 border-green-700 text-white";
             else if (status === 'wrong' && word === selected) style = "bg-red-500 border-red-700 text-white";
             
             return (
              <button 
                key={idx}
                onClick={() => handleGuess(word)}
                disabled={status !== 'listening'}
                className={`py-4 rounded-2xl font-bold text-lg transition-all active:scale-95 active:border-b-0 active:translate-y-1 ${style}`}
              >
                {word}
              </button>
             );
          })}
        </div>
      </div>

      <FeedbackArea status={status} nextFn={nextQuestion} explanation="" />
    </div>
  );
}

// 4. Number Cruncher
function NumberCruncherGame({ onScore, goHome }) {
  const [qIndex, setQIndex] = useState(0);
  const [input, setInput] = useState("");
  const [status, setStatus] = useState('playing');

  const question = NUMBER_DATA[qIndex];
  const isFinished = !question;

  useEffect(() => {
    if (question) {
      setInput("");
      setStatus('playing');
      setTimeout(() => speak(question.audioText), 600);
    }
  }, [qIndex, question]);

  const handleNumClick = (num) => {
    if (status !== 'playing') return;
    if (input.length < 10) setInput(prev => prev + num);
  };
  
  const handleDelete = () => {
    if (status !== 'playing') return;
    setInput(prev => prev.slice(0, -1));
  };

  const checkAnswer = () => {
    // Basic normalization: remove spaces or dashes just in case, though our keypad doesn't have them
    const cleanInput = input.replace(/[^0-9.]/g, '');
    const cleanAnswer = question.answer.replace(/[^0-9.]/g, '');
    
    if (cleanInput === cleanAnswer) {
      setStatus('correct');
      speak("Correct!");
      onScore();
    } else {
      setStatus('wrong');
      speak("Listen again.");
    }
  };

  const nextQuestion = () => {
    setQIndex(prev => prev + 1);
  };

  if (isFinished) return <GameOver score="Math Genius!" onRetry={goHome} color="rose" />;

  return (
    <div className="flex flex-col h-full p-4 animate-in slide-in-from-right duration-300">
      <ProgressBar current={qIndex} total={NUMBER_DATA.length} color="bg-rose-400" />
      
      <div className="flex justify-center mt-4 mb-2">
        <AudioButton onClick={() => speak(question.audioText)} color="rose" small />
      </div>

      {/* Display Screen */}
      <div className={`w-full bg-slate-900 rounded-2xl p-6 mb-4 flex flex-col items-end justify-center min-h-[100px] border-4 ${status === 'correct' ? 'border-green-400' : 'border-slate-700'}`}>
         <span className="text-white text-4xl font-mono tracking-widest">{input || "_"}</span>
      </div>
      
      <p className="text-center text-slate-400 text-sm mb-4 font-medium">{question.hint}</p>

      {/* Custom Keypad */}
      <div className="grid grid-cols-3 gap-3 w-full max-w-xs mx-auto mb-4">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, '.', 0].map((num) => (
          <button
            key={num}
            onClick={() => handleNumClick(num.toString())}
            className="bg-white text-slate-700 text-2xl font-bold py-3 rounded-xl shadow-[0_3px_0_0_rgba(0,0,0,0.1)] active:shadow-none active:translate-y-1 transition-all border border-slate-200"
          >
            {num}
          </button>
        ))}
         <button onClick={handleDelete} className="bg-rose-100 text-rose-600 rounded-xl shadow-[0_3px_0_0_rgba(0,0,0,0.1)] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center">
            <Delete className="w-6 h-6" />
         </button>
      </div>

      {status === 'playing' || status === 'wrong' ? (
        <button 
          onClick={checkAnswer} 
          className={`w-full py-4 rounded-2xl font-black text-white shadow-[0_4px_0_0_rgba(0,0,0,0.2)] active:shadow-none active:translate-y-1 transition-all mt-auto ${status === 'wrong' ? 'bg-red-500 hover:bg-red-600' : 'bg-rose-500 hover:bg-rose-600'}`}
        >
          {status === 'wrong' ? 'Try Again' : 'Check'}
        </button>
      ) : (
        <button 
          onClick={nextQuestion} 
          className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-black shadow-[0_4px_0_0_#15803d] active:shadow-none active:translate-y-1 transition-all mt-auto"
        >
          Next
        </button>
      )}
    </div>
  );
}

// --- SHARED UI COMPONENTS ---

function GameOver({ score, onRetry, color }) {
  return (
    <div className="h-full flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-500">
      <div className={`w-24 h-24 bg-${color}-100 rounded-full flex items-center justify-center mb-6 text-${color}-500 shadow-sm border-4 border-${color}-200`}>
        <Trophy className="w-12 h-12 fill-current" />
      </div>
      <h2 className="text-3xl font-black text-slate-800 mb-2">Awesome!</h2>
      <p className="text-slate-500 mb-10 font-medium text-lg">{score}</p>
      <button 
        onClick={onRetry}
        className={`px-8 py-4 bg-${color}-500 text-white rounded-2xl font-bold shadow-[0_4px_0_0_rgba(0,0,0,0.2)] hover:scale-105 active:scale-95 active:shadow-none active:translate-y-1 transition-all flex items-center gap-2`}
      >
        <RefreshCw className="w-5 h-5" /> Play Again
      </button>
    </div>
  );
}

function ProgressBar({ current, total, color }) {
  return (
    <div className="w-full bg-white h-3 rounded-full mb-6 border border-slate-200 overflow-hidden">
      <div 
        className={`${color} h-full rounded-full transition-all duration-500 ease-out`} 
        style={{ width: `${((current + 1) / total) * 100}%` }}
      ></div>
    </div>
  );
}

function AudioButton({ onClick, color, small }) {
  return (
    <button 
      onClick={onClick}
      className={`${small ? 'w-16 h-16' : 'w-24 h-24'} bg-white border-4 border-${color}-100 rounded-full flex items-center justify-center text-${color}-500 hover:scale-110 active:scale-90 transition-all shadow-sm`}
    >
      <Play className={`${small ? 'w-6 h-6' : 'w-10 h-10'} ml-1 fill-current`} />
    </button>
  );
}

function FeedbackArea({ status, nextFn, explanation }) {
  return (
    <div className={`mt-auto w-full p-4 rounded-2xl flex items-center gap-3 transition-all duration-300 ${status === 'listening' ? 'opacity-0 translate-y-8 pointer-events-none' : 'opacity-100 translate-y-0 bg-white shadow-[0_4px_0_0_rgba(0,0,0,0.05)] border-2 border-slate-100'}`}>
      {status === 'correct' && <CheckCircle className="text-green-500 w-8 h-8 shrink-0" />}
      {status === 'wrong' && <XCircle className="text-red-500 w-8 h-8 shrink-0" />}
      <div className="flex-1">
        <p className="font-bold text-slate-800">
          {status === 'correct' ? 'Correct!' : 'Incorrect'}
        </p>
        {explanation && <p className="text-xs text-slate-500">{explanation}</p>}
      </div>
      <button 
        onClick={nextFn}
        className="px-4 py-2 bg-slate-800 text-white text-sm rounded-xl font-bold hover:bg-slate-700 shadow-[0_2px_0_0_#0f172a] active:shadow-none active:translate-y-0.5"
      >
        Next
      </button>
    </div>
  );
}
