<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>British Hills Speech Master</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: 'DM Sans', sans-serif;
            overflow: hidden; 
        }
        
        .font-serif { font-family: 'Playfair Display', serif; }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active {
            animation: pulse-ring 2s infinite;
        }

        .stress-mark {
            color: #fbbf24;
            font-weight: 700;
            font-size: 1.1em;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        
        .pause-mark {
            display: inline-block;
            color: #6b7280;
            font-weight: 300;
            margin-left: 0.5rem;
            font-size: 0.8em;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconMic = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const IconPlay = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        const IconRotate = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
            </svg>
        );

        const IconVolume = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
            </svg>
        );

        const IconAward = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>
        );
        
        const IconHome = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        );


        // --- DATA: THE SPEECH LIBRARY ---
        const SPEECH_LIBRARY = [
            {
                id: 'japan',
                title: "Introducing Japan",
                desc: "Explain Japanese culture to visitors.",
                script: [
                    { clean: "Japan is a beautiful country with four distinct seasons", display: "Japan is a <span class='stress-mark'>beautiful</span> country with <span class='stress-mark'>four</span> distinct seasons." },
                    { clean: "Each season has unique food and events", display: "Each season has <span class='stress-mark'>unique</span> food and events." },
                    { clean: "Japan is famous for things like sushi and manga", display: "Japan is <span class='stress-mark'>famous</span> for things like sushi and manga," },
                    { clean: "but there is much much more to experience", display: "but there is <span class='stress-mark'>much, much</span> more to experience!" },
                    { clean: "Please enjoy your stay", display: "Please <span class='stress-mark'>enjoy</span> your stay!" }
                ]
            },
            {
                id: 'self_intro',
                title: "All About Me",
                desc: "Introduce yourself: Name, age, and likes.",
                script: [
                    { clean: "Hello everyone I'm Yuki", display: "<span class='stress-mark'>Hello</span> everyone, I’m <span class='stress-mark'>Yuki.</span>" },
                    { clean: "I'm from Fukushima and I am twelve years old", display: "I’m from Fukushima, and I am <span class='stress-mark'>twelve</span> years old." },
                    { clean: "I like playing football but I love volleyball", display: "I <span class='stress-mark'>like</span> playing football but I <span class='stress-mark'>love</span> volleyball." },
                    { clean: "My favourite music is rock but I like all kinds", display: "My <span class='stress-mark'>favourite</span> music is rock, <span class='stress-mark'>but</span> I like all kinds." },
                    { clean: "Nice to meet you", display: "Nice to meet you." }
                ]
            },
            {
                id: 'dream',
                title: "My Dream",
                desc: "Talk about your future goals.",
                script: [
                    { clean: "I have a big dream", display: "I have a <span class='stress-mark'>big</span> dream." },
                    { clean: "I want to be a doctor", display: "I want to be a <span class='stress-mark'>doctor.</span>" },
                    { clean: "I want to help people", display: "I want to <span class='stress-mark'>help</span> people," },
                    { clean: "so I will study very hard", display: "so I will study <span class='stress-mark'>very</span> hard." },
                    { clean: "Thank you for listening", display: "<span class='stress-mark'>Thank you</span> for listening" }
                ]
            },
            {
                id: 'school',
                title: "My School Life",
                desc: "Describe your school and club.",
                script: [
                    { clean: "I go to junior high school", display: "I go to <span class='stress-mark'>junior</span> high school." },
                    { clean: "My favourite subject is English It's a lot of fun", display: "My <span class='stress-mark'>favourite</span> subject is English. It’s a <span class='stress-mark'>lot</span> of fun!" },
                    { clean: "I am a member of the tennis club", display: "I am a member of the <span class='stress-mark'>tennis</span> club," },
                    { clean: "and I play every Monday and Friday", display: "and I play every Monday and Friday." },
                    { clean: "I really enjoy my school life", display: "I <span class='stress-mark'>really</span> enjoy my school life." }
                ]
            },
            {
                id: 'numbers',
                title: "Fun with Numbers",
                desc: "Practise saying large numbers.",
                script: [
                    { 
                        clean: "There are 5 people in my family", 
                        display: "There are <span class='stress-mark'>5</span> people in my family.",
                        alternates: ["there are five people in my family"] 
                    },
                    { 
                        clean: "There are 32 people in my class", 
                        display: "There are <span class='stress-mark'>32</span> people in my class.",
                        alternates: ["there are thirty two people in my class"]
                    },
                    { 
                        clean: "There are 98 people in my year", 
                        display: "There are <span class='stress-mark'>98</span> people in my year.",
                        alternates: ["there are ninety eight people in my year"]
                    },
                    { 
                        clean: "There are 232 people in my school", 
                        display: "There are <span class='stress-mark'>232</span> people in my school.",
                        alternates: ["there are two hundred thirty two people in my school", "there are two hundred and thirty two people in my school"]
                    },
                    { 
                        clean: "There are 365 days in a year", 
                        display: "There are <span class='stress-mark'>365</span> days in a year.",
                        alternates: ["there are three hundred sixty five days in a year", "there are three hundred and sixty five days in a year"]
                    },
                    { 
                        clean: "There are 17500 people in my town", 
                        display: "There are <span class='stress-mark'>17,500</span> people in my town.",
                        alternates: ["there are seventeen thousand five hundred people in my town", "there are 17,500 people in my town"]
                    }
                ]
            }
        ];

        const App = () => {
            const [selectedSpeech, setSelectedSpeech] = useState(null); 
            const [started, setStarted] = useState(false);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState("");
            const [feedback, setFeedback] = useState("Tap mic to start");
            const [completed, setCompleted] = useState(false);

            const recognitionRef = useRef(null);
            const currentIndexRef = useRef(0);
            const isListeningRef = useRef(false);
            const completedRef = useRef(false);
            const selectedSpeechRef = useRef(null);

            // Sync state to refs
            useEffect(() => {
                currentIndexRef.current = currentIndex;
                isListeningRef.current = isListening;
                completedRef.current = completed;
                selectedSpeechRef.current = selectedSpeech;
            }, [currentIndex, isListening, completed, selectedSpeech]);

            // --- SPEECH RECOGNITION SETUP ---
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false; 
                    recognitionRef.current.interimResults = true; 
                    recognitionRef.current.lang = 'en-GB'; 

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';

                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }

                        const currentInput = (final || interim).toLowerCase();
                        setTranscript(currentInput);
                        
                        checkMatch(currentInput);
                    };

                    recognitionRef.current.onend = () => {
                        if (isListeningRef.current && !completedRef.current) {
                            try { recognitionRef.current.start(); } catch(e){}
                        } else {
                            setIsListening(false);
                        }
                    };
                    
                    recognitionRef.current.onerror = (event) => {
                        if (event.error === 'not-allowed') {
                            setFeedback("Mic blocked. Check settings.");
                            setIsListening(false);
                        }
                    };
                } else {
                    setFeedback("Browser not supported. Use Chrome/Safari.");
                }

                return () => {
                    if (recognitionRef.current) recognitionRef.current.abort();
                };
            }, []); 

            // --- LOGIC ---

            const selectSpeech = (speech) => {
                setSelectedSpeech(speech);
            };

            const startSession = () => {
                setStarted(true);
                setCurrentIndex(0);
                setCompleted(false);
            };

            const goHome = () => {
                setStarted(false);
                setCompleted(false);
                setSelectedSpeech(null);
                setCurrentIndex(0);
                setIsListening(false);
                if (recognitionRef.current) recognitionRef.current.stop();
            };

            const toggleMic = () => {
                if (isListening) {
                    setIsListening(false); 
                    recognitionRef.current.stop();
                    setFeedback("Paused");
                } else {
                    setIsListening(true); 
                    try {
                        recognitionRef.current.start();
                        setFeedback("Listening...");
                    } catch(e) {
                        setFeedback("Re-connecting...");
                    }
                }
            };

            const checkMatch = (spokenText) => {
                if (completedRef.current || !selectedSpeechRef.current) return;
                
                const idx = currentIndexRef.current;
                const scriptLines = selectedSpeechRef.current.script;
                const currentPhrase = scriptLines[idx];
                
                // FIX: Strip punctuation (like commas in 17,500) from the spoken text too!
                const normalizedSpoken = spokenText.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()'"’]/g,"");
                
                // Build an array of valid targets (the clean string + any alternates)
                let validTargets = [currentPhrase.clean];
                if (currentPhrase.alternates) {
                    validTargets = validTargets.concat(currentPhrase.alternates);
                }

                let isMatch = false;

                // Loop through all targets and check if they exist in the spoken text
                for (let t of validTargets) {
                    let target = t.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()'"’]/g,"");
                    
                    // Exception for names in self-intro: allows them to pass if they say "I'm [Their Name]"
                    if (target.includes("hello everyone im yuki")) {
                        if (normalizedSpoken.includes("hello everyone im") || normalizedSpoken.includes("hello everyone i am")) {
                            isMatch = true;
                            break;
                        }
                    }

                    if (normalizedSpoken.includes(target)) {
                        isMatch = true;
                        break;
                    }
                }

                if (isMatch) {
                    handleSuccess();
                }
            };

            const handleSuccess = () => {
                setTranscript(""); 
                
                const currentIdx = currentIndexRef.current;
                const scriptLines = selectedSpeechRef.current.script;

                if (currentIdx < scriptLines.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                } else {
                    setCompleted(true);
                    setIsListening(false);
                    if (recognitionRef.current) recognitionRef.current.stop();
                }
            };

            // --- RENDER ---

            if (!selectedSpeech) {
                return (
                    <div className="min-h-screen flex flex-col p-6 max-w-md mx-auto">
                        <div className="text-center mb-8 pt-8">
                            <h1 className="text-4xl font-serif font-bold mb-2 text-white">Speech Master</h1>
                            <p className="text-gray-400">Choose a speech to practice</p>
                        </div>

                        <div className="space-y-4 flex-1 overflow-y-auto custom-scroll pb-10">
                            {SPEECH_LIBRARY.map((s) => (
                                <button
                                    key={s.id}
                                    onClick={() => selectSpeech(s)}
                                    className="w-full text-left p-6 bg-gray-800 hover:bg-gray-700 rounded-xl border border-gray-700 hover:border-blue-500 transition-all group"
                                >
                                    <h3 className="text-xl font-bold text-white mb-1 group-hover:text-blue-400">{s.title}</h3>
                                    <p className="text-gray-400 text-sm">{s.desc}</p>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (!started) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center max-w-md mx-auto">
                        <button onClick={goHome} className="absolute top-6 left-6 text-gray-500 hover:text-white">
                            <IconHome className="w-6 h-6" />
                        </button>

                        <div className="mb-8 p-6 bg-gray-800 rounded-full shadow-2xl border border-gray-700">
                            <IconVolume className="text-blue-400 w-16 h-16" />
                        </div>
                        <h2 className="text-gray-400 text-sm uppercase tracking-widest font-bold mb-2">Selected Topic</h2>
                        <h1 className="text-4xl md:text-5xl font-serif font-bold mb-8 text-white">{selectedSpeech.title}</h1>
                        
                        <div className="bg-gray-800 p-4 rounded-lg text-left w-full mb-8 border border-gray-700">
                            <h3 className="text-gray-400 text-xs uppercase tracking-widest font-bold mb-3">Legend</h3>
                            <div className="space-y-2">
                                <p className="text-gray-300"><span className="text-amber-400 font-bold">Bold Gold</span> = Add Stress</p>
                                <p className="text-gray-300"><span className="text-gray-500">/</span> = Short Pause</p>
                            </div>
                        </div>

                        <button 
                            onClick={startSession}
                            className="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-full font-bold text-xl transition-all hover:scale-105 shadow-lg flex items-center gap-3 w-full justify-center"
                        >
                            <IconPlay className="w-6 h-6" /> Start Practice
                        </button>
                    </div>
                );
            }

            if (completed) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                        <IconAward className="text-amber-400 w-20 h-20 mb-6 animate-bounce" />
                        <h1 className="text-4xl font-serif font-bold mb-2 text-white">Excellent Work!</h1>
                        <p className="text-gray-400 mb-8">You've completed the "{selectedSpeech.title}" speech.</p>
                        <div className="space-y-4 w-full max-w-xs">
                            <button 
                                onClick={startSession}
                                className="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white px-8 py-3 rounded-full font-bold transition-all flex items-center justify-center gap-2"
                            >
                                <IconRotate className="w-5 h-5" /> Practice Again
                            </button>
                            <button 
                                onClick={goHome}
                                className="w-full bg-transparent hover:bg-gray-900 text-gray-400 px-8 py-3 rounded-full font-bold transition-all"
                            >
                                Choose Different Speech
                            </button>
                        </div>
                    </div>
                );
            }

            const scriptLines = selectedSpeech.script;
            const currentPhrase = scriptLines[currentIndex];
            const nextPhrase = scriptLines[currentIndex + 1];
            const progressPercentage = ((currentIndex) / scriptLines.length) * 100;

            return (
                <div className="min-h-screen flex flex-col max-w-2xl mx-auto">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={goHome} className="text-gray-500 hover:text-white">
                                <IconHome className="w-5 h-5" />
                            </button>
                            <span className="text-xs font-bold text-gray-500 uppercase tracking-widest truncate ml-4">
                                {selectedSpeech.title}
                            </span>
                        </div>
                        <div className="flex justify-between items-end mb-2">
                            <span className="text-xs font-bold text-gray-500 uppercase tracking-widest">Progress</span>
                            <span className="text-xs font-mono text-gray-400">{currentIndex + 1} / {scriptLines.length}</span>
                        </div>
                        <div className="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                            <div className="bg-blue-500 h-full progress-bar" style={{ width: `${progressPercentage}%` }}></div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                        <div className="w-full text-center space-y-8">
                            <div className="relative">
                                <h2 
                                    className="text-4xl md:text-6xl font-serif leading-tight text-white transition-all duration-300"
                                    dangerouslySetInnerHTML={{ __html: currentPhrase.display + "<span class='pause-mark'>/</span>" }} 
                                />
                                {nextPhrase && (
                                    <div className="absolute top-full left-0 w-full mt-8 opacity-20 blur-[1px] transform scale-90 transition-all duration-500">
                                        <p 
                                            className="text-3xl font-serif text-gray-400"
                                            dangerouslySetInnerHTML={{ __html: nextPhrase.display }} 
                                        />
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="p-8 pb-12 flex flex-col items-center bg-gradient-to-t from-gray-900 to-transparent">
                        <div className="h-12 w-full flex items-center justify-center mb-6">
                            <p className="text-gray-500 italic text-lg truncate max-w-md">
                                {transcript || "..."}
                            </p>
                        </div>
                        <button 
                            onClick={toggleMic}
                            className={`w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 shadow-2xl ${
                                isListening 
                                ? "bg-red-500 text-white mic-active" 
                                : "bg-gray-700 text-gray-400 hover:bg-gray-600 hover:text-white"
                            }`}
                        >
                            <IconMic className="w-8 h-8" />
                        </button>
                        <p className={`mt-4 text-sm font-medium ${isListening ? "text-red-400" : "text-gray-500"}`}>
                            {feedback}
                        </p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
